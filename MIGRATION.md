# Arborium Crate Migration Guide

This document explains how to migrate from the old `crates/arborium-*` structure to the new `langs/group-*/*/` structure as described in [PUBLISH.md](PUBLISH.md).

## Overview

We're transitioning from:
```
crates/
├── arborium-rust/
│   ├── arborium.kdl
│   ├── grammar/
│   ├── queries/
│   ├── samples/
│   ├── Cargo.toml      # generated
│   ├── build.rs        # generated
│   └── src/            # generated
```

To:
```
langs/
├── group-birch/
│   ├── rust/
│   │   ├── def/                  # committed/persistent
│   │   │   ├── arborium.kdl
│   │   │   ├── grammar/
│   │   │   ├── queries/
│   │   │   └── samples/
│   │   ├── crate/                # generated (optional)
│   │   └── npm/                  # generated (optional)
```

## Migration Tools

Two Node.js scripts are provided:

### 1. `migration-summary.js` - Preview Migration Plan

Shows which languages will be moved to which groups:

```bash
node migration-summary.js
```

This displays:
- All language groups and their target languages
- Group descriptions and language counts
- Any unmapped languages that will be skipped
- Summary statistics

### 2. `migrate-crates.js` - Perform Migration

The main migration script with several modes:

#### Dry Run (Preview Only)
```bash
# Preview all migrations
node migrate-crates.js --dry-run

# Preview specific crates
node migrate-crates.js --dry-run arborium-rust arborium-python

# Preview with generated files included
node migrate-crates.js --dry-run --include-generated
```

#### Execute Migration
```bash
# Migrate all language crates
node migrate-crates.js

# Migrate specific crates only
node migrate-crates.js arborium-rust arborium-python arborium-javascript

# Include generated files (Cargo.toml, build.rs, src/)
node migrate-crates.js --include-generated
```

## Language Group Mapping

Languages are organized into thematic groups:

- **group-acorn** (Web languages): html, css, javascript, typescript, json, xml, etc.
- **group-birch** (Systems): rust, c, cpp, go, zig, asm, etc.
- **group-cedar** (JVM): java, kotlin, scala, clojure
- **group-fern** (Functional): haskell, ocaml, elm, agda, scheme, etc.
- **group-hazell** (Scripting): python, ruby, bash, lua, perl, etc.
- **group-maple** (Data/Config): yaml, toml, json, nginx, dockerfile, etc.
- **group-moss** (Academic/Research): r, matlab, prolog, verilog, etc.
- **group-pine** (Modern): swift, dart, rescript, starlark, etc.
- **group-sage** (.NET/Editors): c-sharp, vb, vim, elisp, etc.
- **group-willow** (Web frameworks/Docs): svelte, vue, markdown, typst, etc.

## What Gets Moved

### Committed/Persistent Files → `def/`
- `arborium.kdl` - Language definition and metadata
- `grammar/` - Tree-sitter grammar files
- `queries/` - Highlight queries and other tree-sitter queries
- `samples/` - Test samples directory
- `sample.*` - Individual sample files
- Additional language-specific files (`.scm`, `.kdl`, `.md`, `.txt`, etc.)

### Generated Files → `crate/` (Optional)
- `Cargo.toml` - Rust crate manifest
- `build.rs` - Build script
- `src/` - Generated Rust source code

By default, generated files are left in the source and will be regenerated by `xtask gen`. Use `--include-generated` to move them to `crate/` directories.

## Step-by-Step Migration

1. **Review the migration plan:**
   ```bash
   node migration-summary.js
   ```

2. **Adjust groupings if needed** by editing `LANGUAGE_GROUPS` in `migrate-crates.js`

3. **Test with dry run:**
   ```bash
   node migrate-crates.js --dry-run
   ```

4. **Migrate a few test cases first:**
   ```bash
   node migrate-crates.js arborium-rust arborium-python
   ```

5. **Verify the results:**
   ```bash
   ls -la langs/group-*/*/def/
   ```

6. **Migrate remaining crates:**
   ```bash
   node migrate-crates.js
   ```

## Safety Features

- **Dry run mode**: Preview all operations before execution
- **Selective migration**: Migrate specific crates only
- **Copy-then-delete**: Files are copied before source deletion
- **Directory creation**: Target directories created automatically
- **Unexpected file detection**: Warns about files not in expected categories

## Excluded Crates

These crates are not language parsers and will not be migrated:
- `arborium` - Main inventory crate
- `arborium-host` - Host runtime
- `arborium-plugin-runtime` - Plugin runtime
- `arborium-sysroot` - Build sysroot
- `arborium-test-harness` - Testing framework
- `arborium-wire` - Wire protocol
- `miette-arborium` - Error handling

## Post-Migration

After migration:

1. **Clean up old crates** (if desired):
   ```bash
   # Remove empty crate directories
   find crates/ -name "arborium-*" -type d -empty -delete
   ```

2. **Regenerate build files:**
   ```bash
   cargo xtask gen --version 0.0.0-dev
   ```

3. **Test the new structure:**
   ```bash
   cargo build
   cargo test
   ```

## Troubleshooting

### "Unexpected items found"
The script warns about files it doesn't recognize. Review these manually and either:
- Add them to the committed items pattern in the script
- Move them manually to the appropriate location
- Delete them if they're obsolete

### Missing directories
If target group directories don't exist, they'll be created automatically.

### Permission errors
Ensure you have write permissions in both `crates/` and `langs/` directories.

## Reverting Migration

If needed, you can reverse the migration by:
1. Copying `def/` contents back to recreated `crates/arborium-*/` directories
2. Running `cargo xtask gen` to regenerate the build files
3. Removing the `langs/` structure

However, it's recommended to test thoroughly with dry runs and selective migration first.